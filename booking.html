<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>龍舟隊出席登記</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f5f5f5; margin: 0; padding-bottom: 80px; }
        
        /* Header */
        .header { background: #fff; padding: 20px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .user-name { font-size: 1.2rem; font-weight: bold; color: #333; }
        
        /* Tabs */
        .tabs { display: flex; background: #fff; margin-top: 10px; border-bottom: 1px solid #ddd; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; color: #888; font-weight: 500; border-bottom: 3px solid transparent; }
        .tab.active { color: #06c755; border-bottom: 3px solid #06c755; }
        
        /* Content */
        .content { padding: 15px; display: none; }
        .content.active { display: block; }
        
        /* List Items */
        .date-item { background: #fff; margin-bottom: 12px; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .date-info { display: flex; flex-direction: column; }
        .date-text { font-size: 1.1rem; font-weight: bold; color: #333; }
        .week-text { font-size: 0.9rem; color: #888; margin-top: 4px; }
        
        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #06c755; }
        input:checked + .slider:before { transform: translateX(22px); }
        
        /* Attendees List (Right Tab) */
        .attendee-list { margin-top: 8px; font-size: 0.95rem; color: #555; line-height: 1.5; }
        .attendee-tag { display: inline-block; background: #e8f5e9; color: #06c755; padding: 2px 8px; border-radius: 4px; margin: 2px; font-size: 0.85rem; }
        .empty-tag { color: #aaa; font-style: italic; font-size: 0.9rem; }

        /* Floating Action Button */
        .fab-container { position: fixed; bottom: 20px; left: 0; right: 0; padding: 0 20px; text-align: center; }
        .btn-save { width: 100%; max-width: 400px; padding: 15px; background: #06c755; color: white; border: none; border-radius: 50px; font-size: 1.1rem; font-weight: bold; box-shadow: 0 4px 15px rgba(6, 199, 85, 0.4); cursor: pointer; }
        .btn-save:disabled { background: #ccc; box-shadow: none; }
    </style>
</head>
<body>

    <div class="header">
        <div id="userName" class="user-name">載入中...</div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('register')">我要報名</div>
        <div class="tab" onclick="switchTab('view')">出席名單</div>
    </div>

    <div id="tab-register" class="content active">
        <div id="registerList"></div>
    </div>

    <div id="tab-view" class="content">
        <div id="viewList"></div>
    </div>

    <div class="fab-container" id="saveBtnContainer">
        <button id="saveBtn" class="btn-save" onclick="saveChanges()">更新出席意願</button>
    </div>

<script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbx5UArJ8asHC5ItNfNQdwMBzFiowVRtXEPDytXUqeO_sVylLNKZOTMhSD6kSRWjJEfy/exec"; // ★ 記得換成新的
        const LIFF_ID = "2009026488-y3Tjhqh5";

        let userProfile = null;
        let globalBookings = {}; // 存後端回傳
        let myPlan = {};         // 存我的暫存變更

        async function main() {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            
            userProfile = await liff.getProfile();
            document.getElementById("userName").innerText = userProfile.displayName;

            await loadData(); // 載入資料
        }

        // 1. 生成未來日期
        function generateDates() {
            let dates = [];
            let today = new Date();
            // 為了測試方便，我們抓今天開始往後算
            let target = new Date(today);
            
            for (let i = 0; i < 60; i++) {
                let day = target.getDay(); // 0=Sun, 3=Wed, 6=Sat
                // 這裡設定週三(3)、週六(6)、週日(0)
                if (day === 0 || day === 3 || day === 6) {
                    let dateStr = target.toISOString().split('T')[0];
                    // 修正時區導致的日期誤差，建議用本地字串處理
                    // 簡易修正：
                    const offset = target.getTimezoneOffset() * 60000;
                    const localISOTime = (new Date(target - offset)).toISOString().slice(0, 10);

                    let weekMap = ['日', '一', '二', '三', '四', '五', '六'];
                    dates.push({
                        date: localISOTime,
                        week: weekMap[day]
                    });
                }
                target.setDate(target.getDate() + 1);
            }
            return dates;
        }

        // 2. ★ 修正：改用 GET 讀取資料
        async function loadData() {
            // 顯示 Loading
            Swal.fire({title: '讀取資料中...', didOpen: () => { Swal.showLoading() }});

            try {
                // 使用 GET 請求，參數帶在 URL 上
                let fetchUrl = `${GAS_URL}?action=fetch_bookings&t=${new Date().getTime()}`; // 加 timestamp 防快取
                
                let response = await fetch(fetchUrl);
                globalBookings = await response.json(); 
                
                // 資料讀取成功，關閉 Loading
                Swal.close();
                
                // 重新渲染畫面
                renderUI(generateDates());

            } catch (e) {
                console.error(e);
                Swal.fire("讀取失敗", "無法連結伺服器", "error");
            }
        }

        function renderUI(dates) {
            const regList = document.getElementById("registerList");
            const viewList = document.getElementById("viewList");
            
            regList.innerHTML = "";
            viewList.innerHTML = "";

            dates.forEach(d => {
                // --- 邏輯判斷 ---
                // 檢查該日期目前有哪些人 (從後端抓的)
                let attendees = globalBookings[d.date] || [];
                let count = attendees.length;
                
                // 判斷「我」是否在名單內，決定 Toggle 狀態
                // 優先權：如果 myPlan 有操作過以 myPlan 為主，否則以 globalBookings 為主
                let isJoined = false;
                if (myPlan.hasOwnProperty(d.date)) {
                    isJoined = (myPlan[d.date] === "JOIN");
                } else {
                    isJoined = attendees.includes(userProfile.displayName);
                }

                // --- 左邊：登記 Tab UI ---
                let item = document.createElement("div");
                item.className = "date-item";
                item.innerHTML = `
                    <div class="date-info">
                        <span class="date-text">${d.date}</span>
                        <span class="week-text">星期${d.week}</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" onchange="togglePlan('${d.date}', this.checked)" ${isJoined ? 'checked' : ''}>
                        <span class="slider"></span>
                    </label>
                `;
                regList.appendChild(item);

                // --- 右邊：檢視 Tab UI (模仿你的截圖樣式) ---
                // 產生名單 HTML (藍色小標籤)
                let attendeesHtml = attendees.length > 0 
                    ? attendees.map(name => `<span class="attendee-tag">${name}</span>`).join('') 
                    : '<span class="empty-tag">尚未有人報名</span>';

                let viewItem = document.createElement("div");
                viewItem.className = "date-item";
                // 使用 Flex column 讓名單排在日期下面
                viewItem.style.flexDirection = "column"; 
                viewItem.style.alignItems = "flex-start";
                
                viewItem.innerHTML = `
                    <div style="width:100%; display:flex; justify-content:space-between; margin-bottom:10px;">
                        <div>
                            <span class="date-text">${d.date}</span>
                            <span class="week-text" style="font-size:0.8rem; margin-left:5px;">(週${d.week})</span>
                        </div>
                        <div style="font-weight:bold; color:#06c755;">
                            ${count} 人參加
                        </div>
                    </div>
                    <div class="attendee-list" style="width:100%;">
                        ${attendeesHtml}
                    </div>
                `;
                viewList.appendChild(viewItem);
            });
        }

        // 使用者切換 Toggle
        function togglePlan(date, status) {
            myPlan[date] = status ? "JOIN" : "CANCEL";
            // 為了 UX，切換時可以即時更新 UI 上的按鈕，但我們先不重繪整個列表以免跳動
        }

        // 儲存變更
        async function saveChanges() {
            const btn = document.getElementById("saveBtn");
            btn.disabled = true;
            btn.innerText = "更新中...";

            let changes = [];
            for (let date in myPlan) {
                // 只有當狀態跟後端不一致時才送出嗎？
                // 為了簡單，我們先把所有操作都送出，後端只負責寫入流水帳
                changes.push({ date: date, type: myPlan[date] });
            }

            if (changes.length === 0) {
                Swal.fire("提示", "沒有變更任何項目", "info");
                btn.disabled = false; btn.innerText = "更新出席意願";
                return;
            }

            try {
                // 寫入依然維持 POST
                await fetch(GAS_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify({
                        action: "update_booking",
                        userName: userProfile.displayName,
                        userId: userProfile.userId,
                        changes: changes
                    })
                });

                await Swal.fire("成功", "出席紀錄已更新！", "success");
                
                // 清空本地變更
                myPlan = {};
                // ★ 關鍵：儲存後，重新從後端拉取最新資料，更新畫面
                await loadData();

            } catch (err) {
                Swal.fire("錯誤", "更新失敗，請檢查網路", "error");
            }

            btn.disabled = false;
            btn.innerText = "更新出席意願";
        }

        // Tab 切換
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            
            if (tabName === 'register') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('tab-register').classList.add('active');
                document.getElementById('saveBtnContainer').style.display = 'block';
            } else {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('tab-view').classList.add('active');
                document.getElementById('saveBtnContainer').style.display = 'none';
                
                // 這裡可以選擇是否要在切換到 Tab 2 時自動 reloadData
                // loadData(); 
            }
        }
        
        // CSS 樣式補充 (請確保你的 CSS 有這段，才能顯示藍色小標籤)
        /*
        .attendee-tag { 
            display: inline-block; 
            background: #e3f2fd; 
            color: #1565c0; 
            padding: 4px 10px; 
            border-radius: 15px; 
            margin: 3px; 
            font-size: 0.9rem; 
            font-weight: 500;
        }
        */

        main();
    </script>

</body>
</html>
